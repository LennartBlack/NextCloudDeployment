apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-init-script
  namespace: nextcloud
  labels:
    app.kubernetes.io/name: nextcloud
    app.kubernetes.io/component: db
data:
  init.sql: |
    CREATE DATABASE IF NOT EXISTS nextcloud;
    CREATE USER IF NOT EXISTS 'nextcloud'@'%' IDENTIFIED BY 'nextcloud123';
    GRANT ALL PRIVILEGES ON nextcloud.* TO 'nextcloud'@'%';
    FLUSH PRIVILEGES;
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-config
  namespace: nextcloud
data:
  collabora.config.php: |
    <?php
    $CONFIG = array (
      'richdocuments' => array(
        'wopi_url' => 'https://collabora.ewe-netz-backup.de',
      ),
    );
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: nextcloud
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      upstream nextcloud {
        server nextcloud.nextcloud.svc.cluster.local:80;
      }

      server {
        listen 80;
        server_name _;
        
        # ACME-Challenges erlauben
        location /.well-known/acme-challenge/ {
          proxy_pass http://nextcloud;
          proxy_set_header Host $http_host;
        }
        
        # Rest umleiten
        location / {
          return 301 https://$host$request_uri;
        }
      }

      server {
        listen 443 ssl;
        server_name _;

        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        client_max_body_size 10G;
        client_body_buffer_size 400M;
        
        add_header Strict-Transport-Security "max-age=15768000; includeSubDomains; preload;" always;

        location / {
          proxy_pass http://nextcloud;
          
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          proxy_set_header X-Forwarded-Host $http_host;
          proxy_set_header X-Forwarded-Port 443;
          
          proxy_redirect off;
          proxy_buffering off;
          proxy_request_buffering off;
          proxy_max_temp_file_size 0;
          
          proxy_connect_timeout 3600;
          proxy_send_timeout 3600;
          proxy_read_timeout 3600;
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: coturn-config
  namespace: nextcloud
data:
  turnserver.conf: |
    listening-port=3478
    tls-listening-port=5349
    
    external-ip="95.33.255.121"
    
    min-port=49152
    max-port=65535
    
    use-auth-secret
    static-auth-secret=0d3e50717c9fff2263babeec3a8b3b86e33252822162642cb35a758087fb76e0
    
    realm=nextcloud
    
    verbose
    log-file=/var/log/turnserver.log
    
    fingerprint
    lt-cred-mech
    
    no-multicast-peers
    no-cli
    no-loopback-peers
    no-stdout-log
    
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: collabora-nginx-config
  namespace: nextcloud
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }

    http {
      upstream collabora {
        server collabora.nextcloud.svc.cluster.local:9980;
      }

      server {
        listen 443 ssl;
        server_name _;

        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;
        
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        client_max_body_size 0;
        proxy_request_buffering off;

        location / {
          proxy_pass http://collabora;
          proxy_http_version 1.1;
          
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto https;
          
          proxy_read_timeout 36000s;
          proxy_connect_timeout 60s;
          proxy_send_timeout 36000s;
        }
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  nextcloud-overview.json: |
    {
      "dashboard": {
        "title": "Nextcloud Overview",
        "panels": [
          {
            "title": "Active Users",
            "targets": [
              {
                "expr": "nextcloud_active_users_total"
              }
            ]
          },
          {
            "title": "Storage Usage",
            "targets": [
              {
                "expr": "nextcloud_storage_usage_bytes"
              }
            ]
          },
          {
            "title": "Database Size",
            "targets": [
              {
                "expr": "mysql_global_status_innodb_data_written"
              }
            ]
          }
        ]
      }
    }